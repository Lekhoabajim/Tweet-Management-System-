package services;

import java.util.List;

import javax.ejb.LocalBean;
import javax.ejb.Stateless;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;

import entities.TweetEntity;
import twitter4j.DirectMessage;
import twitter4j.Twitter;
import twitter4j.TwitterFactory;
import twitter4j.conf.ConfigurationBuilder;

@Stateless
@LocalBean
public class TweetsEJB {

	@PersistenceContext
	private EntityManager em;
	Twitter sender;
	
	public TweetsEJB() {
		ConfigurationBuilder configBuilder = new ConfigurationBuilder();
		configBuilder.setDebugEnabled(true).setOAuthConsumerKey("AkG778DJ7xhHU5Atr89gfDWZ5")
				.setOAuthConsumerSecret("p7yTuyWpOycOaGztE1Z5OvHufoH7UZfsDBrZOsPtmqygMMWEhI")
				.setOAuthAccessToken("928565770161999872-tC0OY0jMJRVfyuJdwjt0exZfpoe0eoM")
				.setOAuthAccessTokenSecret("lSeUJDCQ6DhlMwrBruTh08pMS6ODMWJHYBFqQJTHIS1PV");
		TwitterFactory tfactory = new TwitterFactory(configBuilder.build());
		sender = tfactory.getInstance();
	}
	public void keys()
	{
		ConfigurationBuilder configBuilder = new ConfigurationBuilder();
		configBuilder.setDebugEnabled(true).setOAuthConsumerKey("AkG778DJ7xhHU5Atr89gfDWZ5")
				.setOAuthConsumerSecret("p7yTuyWpOycOaGztE1Z5OvHufoH7UZfsDBrZOsPtmqygMMWEhI")
				.setOAuthAccessToken("928565770161999872-tC0OY0jMJRVfyuJdwjt0exZfpoe0eoM")
				.setOAuthAccessTokenSecret("lSeUJDCQ6DhlMwrBruTh08pMS6ODMWJHYBFqQJTHIS1PV");
		TwitterFactory tfactory = new TwitterFactory(configBuilder.build());
		sender = tfactory.getInstance();
	}

	public void addNew(TweetEntity tweet) {
		System.out.println("### Adding Tweet###");
		em.persist(tweet);
		sendTweet(tweet.tweetBody);
		System.out.println("### tweet Added successfully ####");
	}

	
	public List<TweetEntity> getAllTweets() {
		System.out.println("# All tweets#");
		List<TweetEntity> alltweets = em.createQuery("SELECT t FROM tweets_tbl t").getResultList();
		return alltweets;
	}

	public void sendTweet(String message) {
		try {
			keys();
			DirectMessage response = sender.sendDirectMessage("@AdhLecturer", message);
			System.out.println("Sent: " + message + " to @" + response.getText());
		} catch (Exception e) {
			System.out.println("Theres something wrong with the tweet");
		}
	}
}
